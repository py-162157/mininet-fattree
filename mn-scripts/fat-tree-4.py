from mininet.topo import Topo
from mininet.net import Mininet
from mininet.node import CPULimitedHost
from mininet.link import TCLink
from mininet.util import dumpNodeConnections
from mininet.log import setLogLevel
from mininet.node import OVSController

topos = {'mytopo': (lambda: FatTree4())}

def fat_tree_test():
    topo = FatTree4()
    net = Mininet(topo=topo, host=CPULimitedHost, link=TCLink, controller = OVSController)
    net.start()
    print("Dumping host connections")
    dumpNodeConnections(net.hosts)
    print("Testing network connectivity")
    net.pingAll()
    print("Testing bandwidth between h1 and h4")
    h1s6, h1s16 = net.get('h1s6', 'h1s16')
    net.iperf((h1s6, h1s16))
    net.stop()

def main():
    setLogLevel('info')
    fat_tree_test()

if __name__ == '__main__':
    main()

class FatTree4(Topo):

    def __init__(self):

        # initilaize topology
        Topo.__init__(self)        
        s1 = self.addSwitch('s1')
        s2 = self.addSwitch('s2')
        s3 = self.addSwitch('s3')
        s4 = self.addSwitch('s4')
        s5 = self.addSwitch('s5')
        s6 = self.addSwitch('s6')
        h1s6 = self.addHost('h1s6')
        h2s6 = self.addHost('h2s6')
        s7 = self.addSwitch('s7')
        s8 = self.addSwitch('s8')
        h1s8 = self.addHost('h1s8')
        h2s8 = self.addHost('h2s8')
        s9 = self.addSwitch('s9')
        s10 = self.addSwitch('s10')
        h1s10 = self.addHost('h1s10')
        h2s10 = self.addHost('h2s10')
        s11 = self.addSwitch('s11')
        s12 = self.addSwitch('s12')
        h1s12 = self.addHost('h1s12')
        h2s12 = self.addHost('h2s12')
        s13 = self.addSwitch('s13')
        s14 = self.addSwitch('s14')
        h1s14 = self.addHost('h1s14')
        h2s14 = self.addHost('h2s14')
        s15 = self.addSwitch('s15')
        s16 = self.addSwitch('s16')
        h1s16 = self.addHost('h1s16')
        h2s16 = self.addHost('h2s16')
        s17 = self.addSwitch('s17')
        s18 = self.addSwitch('s18')
        h1s18 = self.addHost('h1s18')
        h2s18 = self.addHost('h2s18')
        s19 = self.addSwitch('s19')
        s20 = self.addSwitch('s20')
        h1s20 = self.addHost('h1s20')
        h2s20 = self.addHost('h2s20')

        self.addLink('s1', 's5', bw=1000)
        self.addLink('s1', 's9', bw=1000)
        self.addLink('s1', 's13', bw=1000)
        self.addLink('s1', 's17', bw=1000)
        self.addLink('s2', 's5', bw=1000)
        self.addLink('s2', 's9', bw=1000)
        self.addLink('s2', 's13', bw=1000)
        self.addLink('s2', 's17', bw=1000)
        self.addLink('s3', 's7', bw=1000)
        self.addLink('s3', 's11', bw=1000)
        self.addLink('s3', 's15', bw=1000)
        self.addLink('s3', 's19', bw=1000)
        self.addLink('s4', 's7', bw=1000)
        self.addLink('s4', 's11', bw=1000)
        self.addLink('s4', 's15', bw=1000)
        self.addLink('s4', 's19', bw=1000)
        self.addLink('s5', 's6', bw=1000)
        self.addLink('s5', 's8', bw=1000)
        self.addLink('s7', 's6', bw=1000)
        self.addLink('s7', 's8', bw=1000)
        self.addLink('s9', 's10', bw=1000)
        self.addLink('s9', 's12', bw=1000)
        self.addLink('s11', 's10', bw=1000)
        self.addLink('s11', 's12', bw=1000)
        self.addLink('s13', 's14', bw=1000)
        self.addLink('s13', 's16', bw=1000)
        self.addLink('s15', 's14', bw=1000)
        self.addLink('s15', 's16', bw=1000)
        self.addLink('s17', 's18', bw=1000)
        self.addLink('s17', 's20', bw=1000)
        self.addLink('s19', 's18', bw=1000)
        self.addLink('s19', 's20', bw=1000)
        self.addLink('s6', 'h1s6', bw=1000)
        self.addLink('s6', 'h2s6', bw=1000)
        self.addLink('s8', 'h1s8', bw=1000)
        self.addLink('s8', 'h2s8', bw=1000)
        self.addLink('s10', 'h1s10', bw=1000)
        self.addLink('s10', 'h2s10', bw=1000)
        self.addLink('s12', 'h1s12', bw=1000)
        self.addLink('s12', 'h2s12', bw=1000)
        self.addLink('s14', 'h1s14', bw=1000)
        self.addLink('s14', 'h2s14', bw=1000)
        self.addLink('s16', 'h1s16', bw=1000)
        self.addLink('s16', 'h2s16', bw=1000)
        self.addLink('s18', 'h1s18', bw=1000)
        self.addLink('s18', 'h2s18', bw=1000)
        self.addLink('s20', 'h1s20', bw=1000)
        self.addLink('s20', 'h2s20', bw=1000)